"""
–¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –∏ –æ—Ç–ª–∞–¥–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è Pydantic-–º–æ–¥–µ–ª–µ–π
–∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –ù–µ–æ—Å–∏–Ω—Ç–µ–∑–µ –ø–æ –∏—Ö ID.
"""

import asyncio
import traceback

from neosintez_api.config import NeosintezConfig
from neosintez_api.core.client import NeosintezClient
from neosintez_api.services import ObjectService, ObjectToModelFactory


async def main():
    """
    –û—Å–Ω–æ–≤–Ω–æ–π —Å—Ü–µ–Ω–∞—Ä–∏–π:
    1. –ü–æ—ç—Ç–∞–ø–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ–± –æ–±—ä–µ–∫—Ç–µ –∏ –µ–≥–æ –∫–ª–∞—Å—Å–µ.
    2. –°–æ–∑–¥–∞–Ω–∏–µ Pydantic-–º–æ–¥–µ–ª–∏ –∏–∑ –æ–±—ä–µ–∫—Ç–∞ —Å –ø–æ–º–æ—â—å—é ObjectToModelFactory.
    3. –í—ã–≤–æ–¥ –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏.
    4. –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å ObjectService.
    """
    # ID –æ–±—ä–µ–∫—Ç–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    test_object_id = "8681c50f-ec53-f011-91e6-005056b6948b"

    print(f"--- –û—Ç–ª–∞–¥–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞ –ø–æ ID: {test_object_id} ---\n")

    settings = NeosintezConfig()
    client = NeosintezClient(settings)

    try:
        # --- –≠—Ç–∞–ø 1: –°–æ–∑–¥–∞–Ω–∏–µ Pydantic-–º–æ–¥–µ–ª–∏ ---
        # –ú—ã –≤—ã–∑—ã–≤–∞–µ–º —Ñ–∞–±—Ä–∏–∫—É, –∫–æ—Ç–æ—Ä–∞—è –∏–Ω–∫–∞–ø—Å—É–ª–∏—Ä—É–µ—Ç –≤—Å—é –ª–æ–≥–∏–∫—É
        # –ï—Å–ª–∏ –Ω–∞ –∫–∞–∫–æ–º-—Ç–æ –∏–∑ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö —à–∞–≥–æ–≤ (–ø–æ–ª—É—á–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞, –∫–ª–∞—Å—Å–∞, –∞—Ç—Ä–∏–±—É—Ç–æ–≤)
        # –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç –æ—à–∏–±–∫–∞, —Ñ–∞–±—Ä–∏–∫–∞ –¥–æ–ª–∂–Ω–∞ –≤—ã–±—Ä–æ—Å–∏—Ç—å –∏—Å–∫–ª—é—á–µ–Ω–∏–µ.
        print("‚ñ∂Ô∏è –≠—Ç–∞–ø 1: –°–æ–∑–¥–∞–Ω–∏–µ Pydantic-–º–æ–¥–µ–ª–∏ —Å –ø–æ–º–æ—â—å—é ObjectToModelFactory...")

        object_to_model_factory = ObjectToModelFactory(client)
        blueprint = await object_to_model_factory.create_from_object_id(test_object_id)

        print(f"‚úÖ –£—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞ Pydantic-–º–æ–¥–µ–ª—å: '{blueprint.model_class.__name__}'")

        print("\n--- –ò—Ç–æ–≥–æ–≤–∞—è –º–æ–¥–µ–ª—å ---")
        print(blueprint.model_instance.model_dump_json(by_alias=True, indent=2))

        # --- –≠—Ç–∞–ø 2: –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ ---
        print("\n‚ñ∂Ô∏è –≠—Ç–∞–ø 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å ObjectService...")
        object_service = ObjectService(client)

        # –ß–∏—Ç–∞–µ–º –æ–±—ä–µ–∫—Ç, –∏—Å–ø–æ–ª—å–∑—É—è –Ω–∞—à—É –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–Ω—É—é –º–æ–¥–µ–ª—å
        reread_object = await object_service.read(test_object_id, blueprint.model_class)
        assert reread_object.name == blueprint.model_instance.name

        print("‚úÖ –ú–æ–¥–µ–ª—å —Å–æ–≤–º–µ—Å—Ç–∏–º–∞, –æ–±—ä–µ–∫—Ç —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ—á–∏—Ç–∞–Ω —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –Ω–æ–≤–æ–π –º–æ–¥–µ–ª–∏.")
        print("\nüéâ –û—Ç–ª–∞–¥–∫–∞ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!")

    except Exception as e:
        print("\n‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏. –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã:")
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º traceback –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –º–µ—Å—Ç–µ –æ—à–∏–±–∫–∏
        tb_str = traceback.format_exc()

        if "–ö–ª–∞—Å—Å —Å ID" in str(e) and "–Ω–µ –Ω–∞–π–¥–µ–Ω" in str(e):
            print("   - –ü—Ä–æ–±–ª–µ–º–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ö–õ–ê–°–°–ï –æ–±—ä–µ–∫—Ç–∞.")
            print(f"   - –î–µ—Ç–∞–ª–∏: {e}")
            print("   - –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:")
            print("     1. API-endpoint –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–ª–∞—Å—Å–∞ –ø–æ ID –≤–µ—Ä–Ω—É–ª 404 Not Found.")
            print("     2. –£ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –ø—Ä–∞–≤ –Ω–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä —ç—Ç–æ–≥–æ –∫–ª–∞—Å—Å–∞.")
        elif "–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞" in str(e):
            print("   - –ü—Ä–æ–±–ª–µ–º–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–∞–º–æ–≥–æ –û–ë–™–ï–ö–¢–ê.")
            print(f"   - –î–µ—Ç–∞–ª–∏: {e}")
            print("   - –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:")
            print(f"     1. –û–±—ä–µ–∫—Ç —Å ID {test_object_id} –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.")
            print("     2. –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –ø—Ä–∞–≤ –Ω–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä –æ–±—ä–µ–∫—Ç–∞.")
        else:
            print("   - –ü—Ä–æ–±–ª–µ–º–∞: –ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞.")
            print(f"   - –î–µ—Ç–∞–ª–∏: {e}")

        print("\n--- –ü–æ–ª–Ω—ã–π Traceback ---")
        print(tb_str)

    finally:
        await client.close()
        print("\n–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ.")


if __name__ == "__main__":
    asyncio.run(main())
